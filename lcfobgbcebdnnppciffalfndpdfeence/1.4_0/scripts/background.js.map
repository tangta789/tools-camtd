{"version":3,"sources":["scripts/background.js"],"names":["add","down","chrome","downloads","cancel","id","s","getUrlCookie","url","cookies","aria2_obj","combination","ifpostback","postaria2obj","notice","sendAnimMsg","addobj","callback","arguments","length","undefined","aria2jsonrpcpath","getStorage","result","parse_url","auth","indexOf","params","unshift","fetch","Date","getTime","toString","method","body","JSON","stringify","headers","Authorization","Content-Type","then","response","json","data","error","console","log","request_auth","match","remove_auth","replace","auth_str","btoa","url_path","link","getAll","format_cookies","i","cookie","push","name","value","join","header","navigator","userAgent","referrer","filename","post_obj","jsonrpc","finalUrl","out","decodeURIComponent","rightadd","info","tab","linkUrl","pageUrl","alert","tabs","create","runtime","onInstalled","addListener","details","previousVersion","preNum","currentUrl","key","size","localStorage","split","map","reg","eval","message","title","notifications","type","iconUrl","setTimeout","_","clear","query","active","forEach","sendMessage","action","getGlobalStatus","testUrl","regs","some","test","getTabUrl","isIgnore","Math","abs","fileSize","setInterval","num","browserAction","setBadgeText","text","setBadgeBackgroundColor","color","onActivated","onUpdated","onClicked","itemId","showDefaultFolder","wasCleared","onDeterminingFilename","downloadUrl","enableFilter","filterUrlsRegs","contextMenus","contexts","onclick"],"mappings":"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","file":"background.js","sourcesContent":["'use strict';\n\n// 'use strict';\n\nchrome.runtime.onInstalled.addListener(function (details) {\n  console.log('previousVersion', details.previousVersion);\n});\n\nvar preNum = 0;\nvar currentUrl = '';\n\nvar getStorage = function getStorage(key) {\n  if (key === 'size') {\n    var size = localStorage['size'] || 0;\n    size = size * 1024 * 1024;\n    return size;\n  } else if (key === 'path') {\n    return localStorage['path'] || 'http://localhost:6800/jsonrpc';\n  } else if (key === 'enableFilter') {\n    return localStorage['enableFilter'] || 'disabled';\n  } else if (key === 'filterUrlRegs') {\n    return localStorage['filterUrlRegs'] ? localStorage['filterUrlRegs'].split(',').map(function (reg) {\n      return eval(reg);\n    }) : [];\n  }\n  return localStorage[key];\n};\n\nvar notice = function notice(message) {\n  var title = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : 'Camtd';\n\n  chrome.notifications.create({\n    type: 'basic',\n    iconUrl: 'images/default/icon-38.png',\n    title: title,\n    message: message\n  }, function (id) {\n    setTimeout(function (_) {\n      chrome.notifications.clear(id);\n    }, 5000);\n  });\n};\n\nvar sendAnimMsg = function sendAnimMsg() {\n  console.log('sending msg');\n  chrome.tabs.query({ active: true }, function (tabs) {\n    tabs.forEach(function (tab) {\n      chrome.tabs.sendMessage(tab.id, {\n        action: 'show-add-task-anim'\n      });\n      console.log('msg send');\n    });\n  });\n};\n\nvar getGlobalStatus = function getGlobalStatus(callback) {\n  postaria2obj({\n    'jsonrpc': '2.0',\n    'method': 'aria2.getGlobalStat',\n    'id': new Date().getTime().toString()\n  }, callback);\n};\n\n// 测试URL是否满足正则集合中某条正则\nvar testUrl = function testUrl(url, regs) {\n  return regs.some(function (reg) {\n    return reg.test(url);\n  });\n};\n\nvar getTabUrl = function getTabUrl() {\n  chrome.tabs.query({ active: true }, function (tabs) {\n    tabs.forEach(function (tab) {\n      currentUrl = tab.url;\n    });\n  });\n};\n\nvar isIgnore = function isIgnore(down) {\n  if (!/^http:|^https:|^ftp:|^sftp:/.test(down.finalUrl) || getStorage('enabled') == 0 || Math.abs(down.fileSize) < getStorage('size')) {\n    console.log('Ignore file');\n    return true;\n  }\n  return false;\n};\n\nsetInterval(function () {\n  getGlobalStatus(function (data) {\n    var num = data['result']['numActive'];\n    if (num > 0) {\n      chrome.browserAction.setBadgeText({ text: num });\n      chrome.browserAction.setBadgeBackgroundColor({ color: '#00CC66' });\n    } else {\n      chrome.browserAction.setBadgeText({ text: '' });\n    }\n    if (preNum > num) {\n      notice('Download completed!');\n    }\n    preNum = num;\n  });\n}, 1000);\n\nchrome.tabs.onActivated.addListener(function () {\n  getTabUrl();\n});\n\nchrome.tabs.onUpdated.addListener(function () {\n  getTabUrl();\n});\n\nchrome.notifications.onClicked.addListener(function (itemId) {\n  // chrome.downloads.show(parseInt(itemId));\n  chrome.downloads.showDefaultFolder();\n  chrome.notifications.clear(itemId, function (wasCleared) {});\n});\n\nchrome.downloads.onDeterminingFilename.addListener(function (down) {\n  if (!getStorage('path')) {\n    alert('Camtd has not been configured');\n    chrome.tabs.create({ 'url': 'options.html' }, function (s) {});\n    return 0;\n  }\n\n  if (isIgnore(down)) {\n    return 0;\n  }\n\n  var downloadUrl = down.finalUrl;\n  var enableFilter = getStorage('enableFilter');\n  var filterUrlsRegs = getStorage('filterUrlRegs');\n  if (enableFilter === 'disabled') {\n    add(down);\n  } else if (enableFilter === 'blacklist') {\n    if (!testUrl(currentUrl, filterUrlsRegs) && !testUrl(downloadUrl, filterUrlsRegs)) {\n      add(down);\n    } else {\n      console.log('blacklist:', currentUrl, downloadUrl);\n    }\n  } else {\n    if (testUrl(currentUrl, filterUrlsRegs) || testUrl(downloadUrl, filterUrlsRegs)) {\n      add(down);\n    } else {\n      console.log('not in whitelist:', currentUrl, downloadUrl);\n    }\n  }\n});\n\nfunction add(down) {\n  chrome.downloads.cancel(down.id, function (s) {});\n  getUrlCookie(down.url, function (cookies) {\n    var aria2_obj = combination(down, cookies);\n    var ifpostback = postaria2obj(aria2_obj);\n    if (ifpostback == 'base64_error') {\n      notice('Error adding tasks to aria2!', 'Error');\n    } else {\n      // notice('Aria2 is starting to download files.', down.filename)\n      sendAnimMsg();\n    }\n  });\n}\n\nfunction postaria2obj(addobj) {\n  var callback = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : null;\n\n  var aria2jsonrpcpath = getStorage('path');\n\n  var result = parse_url(aria2jsonrpcpath);\n  var auth = result[1];\n  if (auth && auth.indexOf('token:') == 0) {\n    if (addobj.params) {\n      addobj.params.unshift(auth);\n    } else {\n      addobj.params = [auth];\n    }\n  }\n\n  fetch(result[0] + '?tm=' + new Date().getTime().toString(), {\n    method: 'POST',\n    body: JSON.stringify(addobj),\n    headers: {\n      'Authorization': auth,\n      'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'\n    }\n  }).then(function (response) {\n    return response.json();\n  }).then(function (data) {\n    if (callback) {\n      callback(data);\n    }\n  }).catch(function (error) {\n    console.error('Error:', error);\n    console.log('Error aria2 configuration!');\n    if (addobj && addobj.method === 'aria2.addUri') {\n      notice('Error adding tasks to aria2,please check the configuration!', 'Error');\n    }\n  });\n\n  return 'ok';\n}\n\nfunction parse_url(url) {\n  var auth_str = request_auth(url);\n  var auth = null;\n  if (auth_str) {\n    if (auth_str.indexOf('token:') == 0) {\n      auth = auth_str;\n    } else {\n      auth = 'Basic ' + btoa(auth_str);\n    }\n  }\n  var url_path = remove_auth(url);\n  function request_auth(url) {\n    return url.match(/^(?:(?![^:@]+:[^:@\\/]*@)[^:\\/?#.]+:)?(?:\\/\\/)?(?:([^:@]*(?::[^:@]*)?)?@)?/)[1];\n  }\n  function remove_auth(url) {\n    return url.replace(/^((?![^:@]+:[^:@\\/]*@)[^:\\/?#.]+:)?(\\/\\/)?(?:(?:[^:@]*(?::[^:@]*)?)?@)?(.*)/, '$1$2$3');\n  }\n  return [url_path, auth];\n}\n\nfunction getUrlCookie(link, callback) {\n  chrome.cookies.getAll({ 'url': link }, function (cookies) {\n    var format_cookies = [];\n    for (var i in cookies) {\n      var cookie = cookies[i];\n      format_cookies.push(cookie.name + '=' + cookie.value);\n    }\n    format_cookies = format_cookies.join('; ');\n    callback(format_cookies);\n  });\n}\n\nfunction combination(down, cookies) {\n\n  var header = [];\n  header.push('Cookie: ' + cookies);\n  header.push('User-Agent: ' + navigator.userAgent);\n  header.push('Connection: keep-alive');\n  header.push('Referer: ' + down.referrer);\n\n  if (down.filename == '') {\n    var post_obj = {\n      'jsonrpc': '2.0',\n      'method': 'aria2.addUri',\n      'id': new Date().getTime().toString(),\n      'params': [[down.finalUrl], {\n        'header': header\n      }]\n    };\n  } else {\n    var post_obj = {\n      'jsonrpc': '2.0',\n      'method': 'aria2.addUri',\n      'id': new Date().getTime().toString(),\n      'params': [[down.finalUrl], {\n        'out': decodeURIComponent(down.filename),\n        'header': header\n      }]\n    };\n  }\n  return post_obj;\n}\n\nfunction rightadd(info, tab) {\n  var down = { filename: '' };\n  down.finalUrl = info.linkUrl;\n  down.referrer = info.pageUrl;\n  if (!getStorage('path')) {\n    alert('Camtd has not been configured');\n    chrome.tabs.create({ 'url': 'options.html' }, function (s) {});\n    return 0;\n  }\n  getUrlCookie(down.finalUrl, function (cookies) {\n    var aria2_obj = combination(down, cookies);\n    var ifpostback = postaria2obj(aria2_obj);\n    if (ifpostback == 'base64_error') {\n      notice('Error adding tasks to aria2!', 'Error');\n    } else {\n      // notice('Aria2 is starting to download files.', down.filename)\n      sendAnimMsg();\n    }\n  });\n}\n\nchrome.contextMenus.create({ 'title': 'Send to Aria2', 'contexts': ['link'], 'onclick': rightadd });"]}